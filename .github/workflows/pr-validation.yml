name: Monorepo PR Validation

on:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. Detect Changes
  changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      gateway: ${{ steps.filter.outputs.gateway }}
      profile: ${{ steps.filter.outputs.profile }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - services/auth/**
              - docker/auth.Dockerfile
            gateway:
              - services/gateway/**
              - docker/gateway.Dockerfile
            profile:
              - services/profile/**
              - docker/profile.Dockerfile

  # 2. Auth validation (unit tests + docker build)
  validate-auth:
    needs: changes
    if: needs.changes.outputs.auth == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Make Gradle wrapper executable
        run: chmod +x gradlew

      - name: Run Auth Unit Tests
        run: ./gradlew :services:auth:test --tests "*Test"

      - name: Run Auth Integration Tests
        run: ./gradlew :services:auth:test --tests "*IT" -DexcludeTags=slow

      - name: Build Auth Docker Image
        run: docker build -t rido-auth-check -f docker/auth.Dockerfile .

  # 3. Gateway validation (docker build only)
  validate-gateway:
    needs: changes
    if: needs.changes.outputs.gateway == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Gateway Docker Image
        run: docker build -t rido-gateway-check -f docker/gateway.Dockerfile .

  # 4. Profile validation (docker build only)
  validate-profile:
    needs: changes
    if: needs.changes.outputs.profile == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Profile Docker Image
        run: docker build -t rido-profile-check -f docker/profile.Dockerfile .

  # 5. Unified Status Check (ONLY fail on real failures)
  ci-pass:
    runs-on: ubuntu-latest
    needs:
      - validate-auth
      - validate-gateway
      - validate-profile
    if: always()
    steps:
      - name: Verify workflow results
        run: |
          echo "validate-auth:    ${{ needs.validate-auth.result }}"
          echo "validate-gateway: ${{ needs.validate-gateway.result }}"
          echo "validate-profile: ${{ needs.validate-profile.result }}"

          if [[ "${{ needs.validate-auth.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-gateway.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-profile.result }}" == "failure" ]]; then
            echo "❌ CI validation failed"
            exit 1
          fi

          echo "✅ CI validation passed"
