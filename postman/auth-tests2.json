{
  "info": {
    "_postman_id": "rido-auth-gateway-massive-suite",
    "name": "RIDO — AUTH + GATEWAY FULL SUITE (8080 ONLY)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:8080" },
    { "key": "username", "value": "" },
    { "key": "password", "value": "" },
    { "key": "accessToken", "value": "" },
    { "key": "refreshToken", "value": "" },
    { "key": "oldRefreshToken", "value": "" },
    { "key": "newAccessToken", "value": "" },
    { "key": "newRefreshToken", "value": "" },
    { "key": "userId", "value": "" },
    { "key": "jti", "value": "" }
  ],
  "item": [
    {
      "name": "0 — SETUP",
      "item": [
        {
          "name": "0.1 Generate Random Credentials",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "const uname = 'user_' + pm.variables.replaceIn('{{$timestamp}}');",
                  "const pwd = 'Pass_' + pm.variables.replaceIn('{{$randomInt}}');",
                  "pm.collectionVariables.set('username', uname);",
                  "pm.collectionVariables.set('password', pwd);",
                  "console.log('Generated user:', uname, 'pwd:', pwd);"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": ["pm.test('Setup OK', () => true);"]
              }
            }
          ],
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/auth/health"
          }
        }
      ]
    },
    {
      "name": "1 — REGISTER",
      "item": [
        {
          "name": "1.1 Register Random User (Expect 200)",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/register",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\", \"password\": \"{{password}}\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(200);"] }
            }
          ]
        },
        {
          "name": "1.2 Duplicate Register (Expect 409)",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/register",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\", \"password\": \"{{password}}\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(409);"] }
            }
          ]
        },
        {
          "name": "1.3 Empty Username (400)",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/register",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"\", \"password\": \"p\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(400);"] }
            }
          ]
        },
        {
          "name": "1.4 Empty Password (400)",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/register",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"u\", \"password\": \"\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(400);"] }
            }
          ]
        },
        {
          "name": "1.5 Very Long Username (400)",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/register",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\", \"password\": \"p1\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(400);"] }
            }
          ]
        }
      ]
    },
    {
      "name": "2 — LOGIN",
      "item": [
        {
          "name": "2.1 Login Success (Store Tokens)",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\", \"password\": \"{{password}}\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.response.to.have.status(200);",
                  "var r = pm.response.json();",
                  "pm.collectionVariables.set('accessToken', r.accessToken);",
                  "pm.collectionVariables.set('refreshToken', r.refreshToken);",
                  "console.log('Logged in — access:', r.accessToken);"
                ]
              }
            }
          ]
        },
        {
          "name": "2.2 Wrong Password → should 401",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\", \"password\": \"wrong\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        },
        {
          "name": "2.3 Wrong Username → 401",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"no_such_user_{{$randomInt}}\", \"password\": \"pass\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        },
        {
          "name": "2.4 Empty Username (400)",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"\", \"password\": \"p\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(400);"] }
            }
          ]
        },
        {
          "name": "2.5 Empty Password (400)",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"u\", \"password\": \"\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(400);"] }
            }
          ]
        }
      ]
    },
    {
      "name": "3 — LOCKOUT (Redis + DB)",
      "item": [
        {
          "name": "3.1 Wrong Attempt 1",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\", \"password\": \"a1\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        },
        {
          "name": "3.2 Wrong Attempt 2",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\", \"password\": \"a2\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        },
        {
          "name": "3.3 Wrong Attempt 3",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\", \"password\": \"a3\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        },
        {
          "name": "3.4 Wrong Attempt 4",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\", \"password\": \"a4\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        },
        {
          "name": "3.5 Wrong Attempt 5 → LOCKOUT EXPECTED (423)",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\", \"password\": \"a5\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(423);"] }
            }
          ]
        },
        {
          "name": "3.6 Correct Password During Lockout → still 423",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\", \"password\": \"{{password}}\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(423);"] }
            }
          ]
        },
        {
          "name": "3.7 DEBUG UNLOCK",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/debug/unlock",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(200);"] }
            }
          ]
        }
      ]
    },
    {
      "name": "4 — /auth/me (DIRECT via Gateway)",
      "item": [
        {
          "name": "4.1 /auth/me Success",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/auth/me",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ]
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.response.to.have.status(200);",
                  "let r = pm.response.json();",
                  "pm.collectionVariables.set('userId', r.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "4.2 Missing Token → 401",
          "request": { "method": "GET", "url": "{{baseUrl}}/auth/me" },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        },
        {
          "name": "4.3 Invalid Token → 401",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/auth/me",
            "header": [
              { "key": "Authorization", "value": "Bearer invalid.token.here" }
            ]
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        }
      ]
    },
    {
      "name": "5 — /auth/me via Gateway Route Test",
      "item": [
        {
          "name": "5.1 Valid Token via Gateway",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/auth/me",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ]
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Gateway returned 200', () => pm.response.to.have.status(200));",
                  "var r = pm.response.json();",
                  "pm.expect(r.id).to.eql(pm.collectionVariables.get('userId'));"
                ]
              }
            }
          ]
        },
        {
          "name": "5.2 Invalid Token via Gateway → 401",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/auth/me",
            "header": [
              { "key": "Authorization", "value": "Bearer abc.def.ghi" }
            ]
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        }
      ]
    },
    {
      "name": "6 — REFRESH TOKEN (Rotation + Replay Detection)",
      "item": [
        {
          "name": "6.1 Refresh Success (Rotate Tokens — SHA256 Backend Test)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "pm.collectionVariables.set('oldRefreshToken', pm.collectionVariables.get('refreshToken'));"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('200 OK — rotated', () => pm.response.to.have.status(200));",
                  "let r = pm.response.json();",
                  "pm.collectionVariables.set('newAccessToken', r.accessToken);",
                  "pm.collectionVariables.set('newRefreshToken', r.refreshToken);",
                  "pm.collectionVariables.set('accessToken', r.accessToken);",
                  "pm.collectionVariables.set('refreshToken', r.refreshToken);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/refresh",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"refreshToken\": \"{{oldRefreshToken}}\" }"
            }
          }
        },
        {
          "name": "6.2 Replay Attack — Reuse Old Refresh Token → 401",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/refresh",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"refreshToken\": \"{{oldRefreshToken}}\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Replay blocked → 401', ()=> pm.response.to.have.status(401));"
                ]
              }
            }
          ]
        },
        {
          "name": "6.3 Random UUID Refresh Token → 401",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/refresh",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"refreshToken\": \"123e4567-e89b-12d3-a456-426614174000\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        },
        {
          "name": "6.4 Malformed Refresh Token → 401",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/refresh",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"refreshToken\": \"not-a-uuid-token\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        },
        {
          "name": "6.5 Missing refreshToken Field → 400",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/refresh",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{ \"nothing\": \"xxx\" }" }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(400);"] }
            }
          ]
        }
      ]
    },
    {
      "name": "7 — Extract JTI (Decode JWT)",
      "item": [
        {
          "name": "7.1 Decode Access Token Payload + Extract JTI",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/auth/me",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ]
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.response.to.have.status(200);",
                  "let token = pm.collectionVariables.get('accessToken');",
                  "let payload = token.split('.')[1];",
                  "payload += '='.repeat((4 - payload.length % 4) % 4);",
                  "let json = JSON.parse(atob(payload));",
                  "pm.collectionVariables.set('jti', json.jti);",
                  "pm.expect(json.jti).to.be.a('string');",
                  "console.log('Extracted JTI:', json.jti);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "8 — LOGOUT (Blacklist Access Token JTI)",
      "item": [
        {
          "name": "8.1 Logout User",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/logout",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"refreshToken\": \"{{refreshToken}}\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Logout OK', ()=> pm.response.to.have.status(200));",
                  "console.log('JTI blacklisted:', pm.collectionVariables.get('jti'));"
                ]
              }
            }
          ]
        },
        {
          "name": "8.2 Manual Redis Check (optional)",
          "request": {
            "method": "GET",
            "url": "http://localhost:9999/REDIS_CHECK_MANUALLY"
          },
          "description": "Run manually:\n docker compose exec redis redis-cli KEYS auth:jti:blacklist:*"
        }
      ]
    },
    {
      "name": "9 — Token must fail after Logout (JTI Blacklist)",
      "item": [
        {
          "name": "9.1 /auth/me → 401 (Direct via Gateway)",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/auth/me",
            "header": [
              { "key": "Authorization", "value": "Bearer {{accessToken}}" }
            ]
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        },
        {
          "name": "9.2 Refresh after logout → 401",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/refresh",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"refreshToken\": \"{{refreshToken}}\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(401);"] }
            }
          ]
        }
      ]
    },
    {
      "name": "10 — Malformed JSON Tests",
      "item": [
        {
          "name": "10.1 Login with malformed JSON → 400/415",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/login",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"u\", \"password\": \"p\""
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": ["pm.expect(pm.response.code).to.be.oneOf([400,415]);"]
              }
            }
          ]
        },
        {
          "name": "10.2 Register with plain-text body → 400/415",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/register",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "this is not json" }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": ["pm.expect(pm.response.code).to.be.oneOf([400,415]);"]
              }
            }
          ]
        },
        {
          "name": "10.3 Refresh with empty body → 400/415",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/refresh",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "" }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": ["pm.expect(pm.response.code).to.be.oneOf([400,415]);"]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "11 — DEBUG /auth/debug/unlock (DEV ONLY)",
      "item": [
        {
          "name": "11.1 Unlock User",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/debug/unlock",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{ \"username\": \"{{username}}\" }"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": { "exec": ["pm.response.to.have.status(200);"] }
            }
          ]
        }
      ]
    }
  ]
}
