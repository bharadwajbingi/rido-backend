version: "3.9"

services:
  tempo:
    image: grafana/tempo:latest
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      - "3100:3100" # HTTP
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ./otel/tempo.yaml:/etc/tempo.yaml
    networks:
      - observability-net

  # ===========================
  # VAULT (Secrets Management)
  # ===========================
  vault:
    image: hashicorp/vault:latest
    container_name: vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_ADDR: http://127.0.0.1:8200
    cap_add:
      - IPC_LOCK
    networks:
      - internal-net  # Vault accessible to services

  # ===========================
  # POSTGRES
  # ===========================
  postgres:
    image: postgres:15
    container_name: postgres
    environment:
      POSTGRES_DB: ride_hailing
      POSTGRES_USER: rh_user
      POSTGRES_PASSWORD: rh_pass
      TZ: Asia/Kolkata
      PGTZ: Asia/Kolkata
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./initdb:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - db-net  # Isolated database network

  # ===========================
  # REDIS
  # ===========================
  redis:
    image: redis:7
    container_name: redis
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ports:
      - "6379:6379"
    networks:
      - db-net  # Redis only accessible to services

  # ===========================
  # AUTH SERVICE
  # ===========================
  auth:
    build:
      context: ../auth
      dockerfile: Dockerfile
    container_name: auth
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_started
    environment:
      SPRING_PROFILES_ACTIVE: dev

      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/ride_hailing
      SPRING_DATASOURCE_USERNAME: rh_user
      SPRING_DATASOURCE_PASSWORD: rh_pass

      REDIS_HOST: redis
      REDIS_PORT: 6379
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      JWT_REFRESH_TTL: 300
      SPRING_CLOUD_VAULT_URI: http://vault:8200
      SPRING_CLOUD_VAULT_TOKEN: root
      SERVER_PORT: 8080

      # ===========================
      # ðŸ”¥ OPEN TELEMETRY AGENT
      # ===========================
      # JAVA_TOOL_OPTIONS: "-javaagent:/otel/opentelemetry-javaagent.jar"
      OTEL_SERVICE_NAME: "auth-service"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://tempo:4318"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "none"
      FIRST_ADMIN_USERNAME: admin
      FIRST_ADMIN_PASSWORD: SuperSecretAdmin123
      ADMIN_SETUP_KEY: InternalSecretKey
      
      # ===========================
      # ðŸ”’ mTLS SERVER CONFIG
      # ===========================
      SERVER_SSL_ENABLED: "true"
      SERVER_SSL_CLIENT_AUTH: "need"
      SERVER_SSL_CERTIFICATE: "/etc/certs/auth/auth.crt"
      SERVER_SSL_CERTIFICATE_PRIVATE_KEY: "/etc/certs/auth/auth.key"
      SERVER_SSL_TRUST_CERTIFICATE: "/etc/certs/ca/ca.crt"

    volumes:
      - ./otel/opentelemetry-javaagent.jar:/otel/opentelemetry-javaagent.jar
      - ./mtls-certs/auth:/etc/certs/auth
      - ./mtls-certs/ca:/etc/certs/ca

    # No external ports - Auth is internal-only, accessed via Gateway
    # ports:
    #   - "8081:8080"
    networks:
      - internal-net  # Service-to-service
      - db-net  # Access to databases
      - observability-net  # Tracing

  # ===========================
  # GATEWAY SERVICE
  # ===========================
  gateway:
    build:
      context: ../gateway
      dockerfile: Dockerfile
    container_name: gateway
    depends_on:
      auth:
        condition: service_started
    environment:
      SPRING_MAIN_ALLOW_BEAN_DEFINITION_OVERRIDING: "true"
      JWKS_URL: https://auth:8080/auth/keys/jwks.json
      
      # ===========================
      # ðŸ”’ mTLS CLIENT CONFIG
      # ===========================
      SPRING_CLOUD_GATEWAY_HTTPCLIENT_SSL_USE_INSECURE_TRUST_MANAGER: "false"
      SPRING_CLOUD_GATEWAY_HTTPCLIENT_SSL_TRUSTED_X509_CERTIFICATES: "/etc/certs/ca/ca.crt"
      SPRING_CLOUD_GATEWAY_HTTPCLIENT_SSL_KEY_STORE_TYPE: PEM
      SPRING_CLOUD_GATEWAY_HTTPCLIENT_SSL_CERTIFICATE: "/etc/certs/gateway/gateway.crt"
      SPRING_CLOUD_GATEWAY_HTTPCLIENT_SSL_CERTIFICATE_PRIVATE_KEY: "/etc/certs/gateway/gateway.key"
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
    volumes:
      - ./mtls-certs/gateway:/etc/certs/gateway
      - ./mtls-certs/ca:/etc/certs/ca

    ports:
      - "8080:8080"
    networks:
      - external-net  # Internet facing
      - internal-net  # Routes to services
      - db-net        # Access to Redis for blacklist

  # ===========================
  # PROMETHEUS
  # ===========================
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - observability-net

  # ===========================
  # GRAFANA
  # ===========================
  grafana:
    image: grafana/grafana:latest
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
    networks:
      - observability-net

# ===========================
# VOLUMES & NETWORKS
# ===========================
volumes:
  pgdata:

networks:
  # External network - Internet facing
  external-net:
    driver: bridge
  
  # Internal network - Service-to-service communication
  internal-net:
    driver: bridge
    internal: false  # Allow outbound for Vault, JWKS
  
  # Database network - Data layer only
  db-net:
    driver: bridge
    internal: true  # No internet access
  
  # Observability network - Monitoring tools
  observability-net:
    driver: bridge
