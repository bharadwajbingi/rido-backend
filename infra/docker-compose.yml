version: "3.9"

services:
  tempo:
    image: grafana/tempo:latest
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      - "3100:3100" # HTTP
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ./otel/tempo.yaml:/etc/tempo.yaml
    networks:
      - observability-net

  # ===========================
  # VAULT (Secrets Management)
  # ===========================
  vault:
    image: hashicorp/vault:latest
    container_name: vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_ADDR: http://127.0.0.1:8200
    cap_add:
      - IPC_LOCK
    networks:
      - internal-net  # Vault accessible to services

  # ===========================
  # POSTGRES
  # ===========================
  postgres:
    image: postgres:15
    container_name: postgres
    environment:
      POSTGRES_DB: ride_hailing
      POSTGRES_USER: rh_user
      POSTGRES_PASSWORD: rh_pass
      TZ: Asia/Kolkata
      PGTZ: Asia/Kolkata
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./initdb:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - db-net  # Isolated database network

  # ===========================
  # REDIS
  # ===========================
  redis:
    image: redis:7
    container_name: redis
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ports:
      - "6379:6379"
    networks:
      - db-net  # Redis only accessible to services

  # ===========================
  # KAFKA & ZOOKEEPER
  # ===========================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - db-net

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - db-net
      - internal-net

  # ===========================
  # AUTH SERVICE
  # ===========================
  auth:
    image: auth-service:latest
    # build:
    #   context: ..
    #   dockerfile: docker/auth.Dockerfile
    container_name: auth
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_started
      vault:
        condition: service_started
    environment:
      SPRING_PROFILES_ACTIVE: dev

      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/ride_hailing
      SPRING_DATASOURCE_USERNAME: rh_user
      SPRING_DATASOURCE_PASSWORD: rh_pass

      REDIS_HOST: redis
      REDIS_PORT: 6379
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      JWT_REFRESH_TTL: 300
      SPRING_CLOUD_VAULT_URI: http://vault:8200
      SPRING_CLOUD_VAULT_TOKEN: root
      
      # ===========================
      # üîê DUAL PORT CONFIGURATION
      # ===========================
      SERVER_PORT: 8443
      ADMIN_SERVER_PORT: 9091

      # ===========================
      # üß™ STANDALONE MODE (Dev/Test)
      # ===========================
      AUTH_STANDALONE_MODE: "true"

      # ===========================
      # üî• OPEN TELEMETRY AGENT
      # ===========================
      # JAVA_TOOL_OPTIONS: "-javaagent:/otel/opentelemetry-javaagent.jar"
      OTEL_SERVICE_NAME: "auth-service"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://tempo:4318"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "none"
      
      # ===========================
      # üîê BOOTSTRAP ADMIN
      # ===========================
      FIRST_ADMIN_USERNAME: admin
      FIRST_ADMIN_PASSWORD: SuperSecretAdmin123
      
      # ===========================
      # üîí mTLS SERVER CONFIG - DISABLED FOR STANDALONE
      # ===========================
      SERVER_SSL_ENABLED: "false"
      SERVER_SSL_CLIENT_AUTH: "none"
      SERVER_SSL_CERTIFICATE: "/etc/certs/auth/auth.crt"
      SERVER_SSL_CERTIFICATE_PRIVATE_KEY: "/etc/certs/auth/auth.key"
      SERVER_SSL_TRUST_CERTIFICATE: "/etc/certs/ca/ca.crt"

    volumes:
      - ./otel/opentelemetry-javaagent.jar:/otel/opentelemetry-javaagent.jar
      - ./mtls-certs/auth:/etc/certs/auth
      - ./mtls-certs/ca:/etc/certs/ca

    # Dual ports:
    # - 8081: User port (mTLS, accessed by Gateway)
    # - 9091: Admin port (HTTP, accessed via VPN/SSH only)
    ports:
      - "8081:8443"
      - "9091:9091"
    networks:
      - internal-net  # Service-to-service
      - db-net  # Access to databases
      - observability-net  # Tracing


  # ===========================
  # PROFILE SERVICE
  # ===========================
  profile:
    build:
      context: ..
      dockerfile: docker/profile.Dockerfile
    container_name: profile
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_started
      kafka:
        condition: service_started
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_R2DBC_URL: r2dbc:postgresql://postgres:5432/ride_hailing
      SPRING_R2DBC_USERNAME: rh_user
      SPRING_R2DBC_PASSWORD: rh_pass
      SPRING_FLYWAY_URL: jdbc:postgresql://postgres:5432/ride_hailing
      SPRING_FLYWAY_USER: rh_user
      SPRING_FLYWAY_PASSWORD: rh_pass
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8080
    ports:
      - "8082:8080"
    networks:
      - internal-net
      - db-net
      - observability-net

  # ===========================
  # GATEWAY SERVICE
  # ===========================
  gateway:
    build:
      context: ..
      dockerfile: docker/gateway.Dockerfile
    container_name: gateway
    depends_on:
      auth:
        condition: service_started
    environment:
      SPRING_MAIN_ALLOW_BEAN_DEFINITION_OVERRIDING: "true"
      JWKS_URL: http://auth:8443/auth/keys/jwks.json
      
      # ===========================
      # üîí mTLS CLIENT CONFIG
      # ===========================
      SPRING_CLOUD_GATEWAY_HTTPCLIENT_SSL_USE_INSECURE_TRUST_MANAGER: "false"
      SPRING_CLOUD_GATEWAY_HTTPCLIENT_SSL_TRUSTED_X509_CERTIFICATES: "/etc/certs/ca/ca.crt"
      SPRING_CLOUD_GATEWAY_HTTPCLIENT_SSL_KEY_STORE_TYPE: PEM
      SPRING_CLOUD_GATEWAY_HTTPCLIENT_SSL_CERTIFICATE: "/etc/certs/gateway/gateway.crt"
      SPRING_CLOUD_GATEWAY_HTTPCLIENT_SSL_CERTIFICATE_PRIVATE_KEY: "/etc/certs/gateway/gateway.key"
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
    volumes:
      - ./mtls-certs/gateway:/etc/certs/gateway
      - ./mtls-certs/ca:/etc/certs/ca

    ports:
      - "8080:8080"
    networks:
      - external-net  # Internet facing
      - internal-net  # Routes to services
      - db-net        # Access to Redis for blacklist

  # ===========================
  # PROMETHEUS
  # ===========================
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - observability-net

  # ===========================
  # GRAFANA
  # ===========================
  grafana:
    image: grafana/grafana:latest
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
    networks:
      - observability-net

# ===========================
# VOLUMES & NETWORKS
# ===========================
volumes:
  pgdata:

networks:
  # External network - Internet facing
  external-net:
    driver: bridge
  
  # Internal network - Service-to-service communication
  internal-net:
    driver: bridge
    internal: false  # Allow outbound for Vault, JWKS
  
  # Database network - Data layer only
  db-net:
    driver: bridge
    internal: true  # No internet access
  
  # Observability network - Monitoring tools
  observability-net:
    driver: bridge
