{
  "info": {
    "_postman_id": "rido-batch-4",
    "name": "Rido Tests - Batch4_Refresh_JWKS",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8080"
    },
    {
      "key": "admin_url",
      "value": "http://localhost:9091"
    },
    {
      "key": "token",
      "value": ""
    },
    {
      "key": "refresh_token",
      "value": ""
    },
    {
      "key": "admin_token",
      "value": ""
    },
    {
      "key": "user_id",
      "value": ""
    },
    {
      "key": "test_user",
      "value": ""
    },
    {
      "key": "test_pass",
      "value": "TestPass123!"
    },
    {
      "key": "session_id",
      "value": ""
    }
  ],
  "item": [
    {
      "name": "04-Refresh Token (20 tests)",
      "item": [
        {
          "name": "[+] Valid refresh",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-Device-Id",
                "value": "test"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"{{refresh_token}}\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('200',()=>pm.response.to.have.status(200));var j=pm.response.json();pm.collectionVariables.set('token',j.accessToken);if(j.refreshToken)pm.collectionVariables.set('refresh_token',j.refreshToken);"
                ]
              }
            }
          ]
        },
        {
          "name": "[+] Refresh has new token",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-Device-Id",
                "value": "test"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"{{refresh_token}}\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('hasToken',()=>pm.expect(pm.response.json().accessToken).to.be.a('string'));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Missing refresh token",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Invalid refresh token",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalid\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Null refresh token",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":null}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Empty refresh token",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Number as token",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":12345}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Array as token",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":[\"token\"]}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Object as token",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":{\"val\":\"token\"}}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 1",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken1\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 2",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken2\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 3",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken3\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 4",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken4\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 5",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken5\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 6",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken6\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 7",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken7\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 8",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken8\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 9",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken9\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 10",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken10\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] Random invalid refresh 11",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/refresh",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"refreshToken\":\"invalidtoken11\"}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('401',()=>pm.expect([401,423]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "05-JWKS (10 tests)",
      "item": [
        {
          "name": "[+] GET /auth/keys/jwks.json",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/auth/keys/jwks.json",
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('200',()=>pm.response.to.have.status(200));"
                ]
              }
            }
          ]
        },
        {
          "name": "[+] JWKS has keys array",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/auth/keys/jwks.json",
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('hasKeys',()=>pm.expect(pm.response.json().keys).to.be.an('array'));"
                ]
              }
            }
          ]
        },
        {
          "name": "[+] Key has kty",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/auth/keys/jwks.json",
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('hasKty',()=>pm.expect(pm.response.json().keys[0].kty).to.exist);"
                ]
              }
            }
          ]
        },
        {
          "name": "[+] Key has kid",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/auth/keys/jwks.json",
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('hasKid',()=>pm.expect(pm.response.json().keys[0].kid).to.exist);"
                ]
              }
            }
          ]
        },
        {
          "name": "[+] Key has alg",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/auth/keys/jwks.json",
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('hasAlg',()=>pm.expect(pm.response.json().keys[0].alg).to.exist);"
                ]
              }
            }
          ]
        },
        {
          "name": "[+] GET well-known",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/auth/keys/.well-known/jwks.json",
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('200',()=>pm.response.to.have.status(200));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] POST not allowed",
          "request": {
            "method": "POST",
            "url": "{{base_url}}/auth/keys/jwks.json",
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('405',()=>pm.expect([405,500]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] PUT not allowed",
          "request": {
            "method": "PUT",
            "url": "{{base_url}}/auth/keys/jwks.json",
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('405',()=>pm.expect([405,500]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] DELETE not allowed",
          "request": {
            "method": "DELETE",
            "url": "{{base_url}}/auth/keys/jwks.json",
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('405',()=>pm.expect([405,500]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        },
        {
          "name": "[-] PATCH not allowed",
          "request": {
            "method": "PATCH",
            "url": "{{base_url}}/auth/keys/jwks.json",
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('405',()=>pm.expect([405,500]).to.include(pm.response.code));"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}