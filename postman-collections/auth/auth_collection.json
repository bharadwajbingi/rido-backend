{
  "info": {
    "name": "Auth Service - Newman Compatible",
    "description": "Newman-compatible E2E tests. Run: newman run Auth_Newman.postman_collection.json -e auth-test-env.json",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. Admin Port (9091)",
      "item": [
        {"name": "1.1 Health Check", "request": {"method": "GET", "header": [], "url": {"raw": "{{admin_url}}/admin/health", "host": ["{{admin_url}}"], "path": ["admin", "health"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Health check returns 200', () => pm.response.to.have.status(200));", "pm.test('Status is UP', () => pm.expect(pm.response.json().status).to.eql('UP'));"], "type": "text/javascript"}}]},
        {"name": "1.2 Admin Login", "request": {"method": "POST", "header": [{"key": "Content-Type", "value": "application/json"}], "body": {"mode": "raw", "raw": "{\"username\": \"admin\", \"password\": \"SuperSecretAdmin123\"}"}, "url": {"raw": "{{admin_url}}/admin/login", "host": ["{{admin_url}}"], "path": ["admin", "login"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Admin login returns 200', () => pm.response.to.have.status(200));", "const jsonData = pm.response.json();", "pm.test('Returns access token', () => pm.expect(jsonData.accessToken).to.be.a('string'));", "pm.environment.set('admin_token', jsonData.accessToken);"], "type": "text/javascript"}}]},
        {"name": "1.3 Create New Admin", "request": {"method": "POST", "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "Authorization", "value": "Bearer {{admin_token}}"}], "body": {"mode": "raw", "raw": "{\"username\": \"new_admin_{{$timestamp}}\", \"password\": \"NewAdmin123!\"}"}, "url": {"raw": "{{admin_url}}/admin/create", "host": ["{{admin_url}}"], "path": ["admin", "create"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Admin creation returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns success status', () => pm.expect(pm.response.json().status).to.eql('ok'));"], "type": "text/javascript"}}]},
        {"name": "1.4 Rotate JWT Keys", "request": {"method": "POST", "header": [{"key": "Authorization", "value": "Bearer {{admin_token}}"}], "url": {"raw": "{{admin_url}}/admin/key/rotate", "host": ["{{admin_url}}"], "path": ["admin", "key", "rotate"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Key rotation returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns new kid', () => pm.expect(pm.response.json().newKid).to.be.a('string'));"], "type": "text/javascript"}}]},
        {"name": "1.5 Get Audit Logs", "request": {"method": "GET", "header": [{"key": "Authorization", "value": "Bearer {{admin_token}}"}], "url": {"raw": "{{admin_url}}/admin/audit/logs?page=0&size=10", "host": ["{{admin_url}}"], "path": ["admin", "audit", "logs"], "query": [{"key": "page", "value": "0"}, {"key": "size", "value": "10"}]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Audit logs returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns logs array', () => pm.expect(pm.response.json().logs).to.be.an('array'));"], "type": "text/javascript"}}]},
        {"name": "1.6 No Token (401)", "request": {"method": "POST", "header": [{"key": "Content-Type", "value": "application/json"}], "body": {"mode": "raw", "raw": "{\"username\": \"x\", \"password\": \"x\"}"}, "url": {"raw": "{{admin_url}}/admin/create", "host": ["{{admin_url}}"], "path": ["admin", "create"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Returns 401', () => pm.response.to.have.status(401));"], "type": "text/javascript"}}]}
      ]
    },
    {
      "name": "2. User Flow",
      "item": [
        {"name": "2.1 Check Username", "request": {"method": "GET", "header": [], "url": {"raw": "{{gateway_url}}/auth/check-username?username={{test_username}}", "host": ["{{gateway_url}}"], "path": ["auth", "check-username"], "query": [{"key": "username", "value": "{{test_username}}"}]}}, "event": [{"listen": "prerequest", "script": {"exec": ["pm.environment.set('test_username', 'testuser_' + Date.now());"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Username check returns 200', () => pm.response.to.have.status(200));"], "type": "text/javascript"}}]},
        {"name": "2.2 Register User", "request": {"method": "POST", "header": [{"key": "Content-Type", "value": "application/json"}], "body": {"mode": "raw", "raw": "{\"username\": \"{{test_username}}\", \"password\": \"TestPass123!\"}"}, "url": {"raw": "{{gateway_url}}/auth/register", "host": ["{{gateway_url}}"], "path": ["auth", "register"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Registration returns 200', () => pm.response.to.have.status(200));"], "type": "text/javascript"}}]},
        {"name": "2.3 Login User", "request": {"method": "POST", "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "X-Device-Id", "value": "newman-device-001"}, {"key": "User-Agent", "value": "Newman/PostmanRuntime"}], "body": {"mode": "raw", "raw": "{\"username\": \"{{test_username}}\", \"password\": \"TestPass123!\"}"}, "url": {"raw": "{{gateway_url}}/auth/login", "host": ["{{gateway_url}}"], "path": ["auth", "login"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Login returns 200', () => pm.response.to.have.status(200));", "const jsonData = pm.response.json();", "pm.test('Returns tokens', () => pm.expect(jsonData.accessToken).to.be.a('string'));", "pm.environment.set('access_token', jsonData.accessToken);", "pm.environment.set('refresh_token', jsonData.refreshToken);", "const parts = jsonData.accessToken.split('.');", "const payload = JSON.parse(Buffer.from(parts[1], 'base64').toString());", "pm.environment.set('user_id', payload.sub);"], "type": "text/javascript"}}]},
        {"name": "2.4 Get Me", "request": {"method": "GET", "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}], "url": {"raw": "{{gateway_url}}/auth/me", "host": ["{{gateway_url}}"], "path": ["auth", "me"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Get me returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns user info', () => pm.expect(pm.response.json().id).to.exist);"], "type": "text/javascript"}}]},
        {"name": "2.5 Get Sessions", "request": {"method": "GET", "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}], "url": {"raw": "{{gateway_url}}/auth/sessions", "host": ["{{gateway_url}}"], "path": ["auth", "sessions"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Sessions returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns array', () => pm.expect(pm.response.json()).to.be.an('array'));"], "type": "text/javascript"}}]},
        {"name": "2.6 Refresh Token", "request": {"method": "POST", "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "X-Device-Id", "value": "newman-device-001"}, {"key": "User-Agent", "value": "Newman/PostmanRuntime"}], "body": {"mode": "raw", "raw": "{\"refreshToken\": \"{{refresh_token}}\"}"}, "url": {"raw": "{{gateway_url}}/auth/refresh", "host": ["{{gateway_url}}"], "path": ["auth", "refresh"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Refresh returns 200', () => pm.response.to.have.status(200));", "const jsonData = pm.response.json();", "pm.test('Returns new token', () => pm.expect(jsonData.accessToken).to.be.a('string'));", "pm.environment.set('access_token', jsonData.accessToken);", "if (jsonData.refreshToken) pm.environment.set('refresh_token', jsonData.refreshToken);"], "type": "text/javascript"}}]},
        {"name": "2.7 Logout", "request": {"method": "POST", "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "Authorization", "value": "Bearer {{access_token}}"}, {"key": "X-Device-Id", "value": "newman-device-001"}, {"key": "User-Agent", "value": "Newman/PostmanRuntime"}], "body": {"mode": "raw", "raw": "{\"refreshToken\": \"{{refresh_token}}\"}"}, "url": {"raw": "{{gateway_url}}/auth/logout", "host": ["{{gateway_url}}"], "path": ["auth", "logout"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Logout returns 200 or 204', () => pm.expect(pm.response.code).to.be.oneOf([200, 204]));"], "type": "text/javascript"}}]}
      ]
    },
    {
      "name": "3. Negative Tests",
      "item": [
        {"name": "3.1 Wrong Password", "request": {"method": "POST", "header": [{"key": "Content-Type", "value": "application/json"}], "body": {"mode": "raw", "raw": "{\"username\": \"{{test_username}}\", \"password\": \"WrongPassword\"}"}, "url": {"raw": "{{gateway_url}}/auth/login", "host": ["{{gateway_url}}"], "path": ["auth", "login"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Wrong password returns 401', () => pm.response.to.have.status(401));"], "type": "text/javascript"}}]},
        {"name": "3.2 No Token", "request": {"method": "GET", "header": [], "url": {"raw": "{{gateway_url}}/auth/me", "host": ["{{gateway_url}}"], "path": ["auth", "me"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('No token returns 401', () => pm.response.to.have.status(401));"], "type": "text/javascript"}}]},
        {"name": "3.3 User on Admin Port", "request": {"method": "POST", "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}, {"key": "Content-Type", "value": "application/json"}], "body": {"mode": "raw", "raw": "{\"username\": \"x\", \"password\": \"x\"}"}, "url": {"raw": "{{admin_url}}/admin/create", "host": ["{{admin_url}}"], "path": ["admin", "create"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('User rejected on admin', () => pm.expect(pm.response.code).to.be.oneOf([401, 403]));"], "type": "text/javascript"}}]},
        {"name": "3.4 Gateway No Admin", "request": {"method": "GET", "header": [], "url": {"raw": "{{gateway_url}}/admin/health", "host": ["{{gateway_url}}"], "path": ["admin", "health"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('Gateway rejects admin routes', () => pm.expect(pm.response.code).to.be.oneOf([404, 503]));"], "type": "text/javascript"}}]}
      ]
    },
    {
      "name": "4. JWKS",
      "item": [
        {"name": "4.1 Get JWKS", "request": {"method": "GET", "header": [], "url": {"raw": "{{gateway_url}}/auth/keys/jwks.json", "host": ["{{gateway_url}}"], "path": ["auth", "keys", "jwks.json"]}}, "event": [{"listen": "test", "script": {"exec": ["pm.test('JWKS returns 200', () => pm.response.to.have.status(200));", "pm.test('Has keys', () => pm.expect(pm.response.json().keys.length).to.be.at.least(1));"], "type": "text/javascript"}}]}
      ]
    }
  ]
}
