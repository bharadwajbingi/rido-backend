{
  "info": {
    "name": "Auth Service - Complete E2E Test (Fixed)",
    "description": "Full end-to-end test collection for Auth service with dual-port architecture.\n\n**Architecture:**\n- Port 8080 (Gateway): Public user endpoints\n- Port 9091 (Admin): Admin-only endpoints (no gateway)\n\n**IMPORTANT: Run tests in order - each folder sequentially!**",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {"key": "gateway_url", "value": "http://localhost:8080"},
    {"key": "admin_url", "value": "http://localhost:9091"},
    {"key": "access_token", "value": ""},
    {"key": "refresh_token", "value": ""},
    {"key": "admin_token", "value": ""},
    {"key": "user_id", "value": ""},
    {"key": "test_username", "value": ""}
  ],
  "item": [
    {
      "name": "1. Admin Port (9091)",
      "item": [
        {
          "name": "1.1 Health Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {"raw": "{{admin_url}}/admin/health", "host": ["{{admin_url}}"], "path": ["admin", "health"]}
          },
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Health check returns 200', () => pm.response.to.have.status(200));", "pm.test('Status is UP', () => pm.expect(pm.response.json().status).to.eql('UP'));"], "type": "text/javascript"}}]
        },
        {
          "name": "1.2 Admin Login (Bootstrap)",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"admin\", \"password\": \"SuperSecretAdmin123\"}"},
            "url": {"raw": "{{admin_url}}/admin/login", "host": ["{{admin_url}}"], "path": ["admin", "login"]}
          },
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Admin login returns 200', () => pm.response.to.have.status(200));", "var jsonData = pm.response.json();", "pm.test('Returns access token', () => pm.expect(jsonData.accessToken).to.be.a('string'));", "pm.globals.set('admin_token', jsonData.accessToken);", "console.log('Admin token saved: ' + jsonData.accessToken.substring(0,50) + '...');"], "type": "text/javascript"}}]
        },
        {
          "name": "1.3 Create New Admin",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "Authorization", "value": "Bearer {{admin_token}}"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"new_admin_{{$timestamp}}\", \"password\": \"NewAdmin123!\"}"},
            "url": {"raw": "{{admin_url}}/admin/create", "host": ["{{admin_url}}"], "path": ["admin", "create"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var token = pm.globals.get('admin_token');", "if (token) { pm.request.headers.upsert({key: 'Authorization', value: 'Bearer ' + token}); }"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Admin creation returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns success status', () => pm.expect(pm.response.json().status).to.eql('ok'));"], "type": "text/javascript"}}]
        },
        {
          "name": "1.4 Rotate JWT Keys",
          "request": {
            "method": "POST",
            "header": [{"key": "Authorization", "value": "Bearer {{admin_token}}"}],
            "url": {"raw": "{{admin_url}}/admin/key/rotate", "host": ["{{admin_url}}"], "path": ["admin", "key", "rotate"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var token = pm.globals.get('admin_token');", "if (token) { pm.request.headers.upsert({key: 'Authorization', value: 'Bearer ' + token}); }"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Key rotation returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns new kid', () => pm.expect(pm.response.json().newKid).to.be.a('string'));"], "type": "text/javascript"}}]
        },
        {
          "name": "1.5 Get Audit Logs",
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{admin_token}}"}],
            "url": {"raw": "{{admin_url}}/admin/audit/logs?page=0&size=10", "host": ["{{admin_url}}"], "path": ["admin", "audit", "logs"], "query": [{"key": "page", "value": "0"}, {"key": "size", "value": "10"}]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var token = pm.globals.get('admin_token');", "if (token) { pm.request.headers.upsert({key: 'Authorization', value: 'Bearer ' + token}); }"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Audit logs returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns logs array', () => pm.expect(pm.response.json().logs).to.be.an('array'));"], "type": "text/javascript"}}]
        },
        {
          "name": "1.6 Admin Endpoint Without Token (401)",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"hacker\", \"password\": \"hack123\"}"},
            "url": {"raw": "{{admin_url}}/admin/create", "host": ["{{admin_url}}"], "path": ["admin", "create"]}
          },
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Returns 401 Unauthorized', () => pm.response.to.have.status(401));"], "type": "text/javascript"}}]
        }
      ]
    },
    {
      "name": "2. User Registration & Login",
      "item": [
        {
          "name": "2.1 Check Username Availability",
          "request": {
            "method": "GET",
            "header": [],
            "url": {"raw": "{{gateway_url}}/auth/check-username?username={{test_username}}", "host": ["{{gateway_url}}"], "path": ["auth", "check-username"], "query": [{"key": "username", "value": "{{test_username}}"}]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["pm.globals.set('test_username', 'testuser_' + Date.now());"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Username check returns 200', () => pm.response.to.have.status(200));", "pm.test('Username is available', () => pm.expect(pm.response.json().available).to.be.true);"], "type": "text/javascript"}}]
        },
        {
          "name": "2.2 Register New User",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"{{test_username}}\", \"password\": \"TestPass123!\"}"},
            "url": {"raw": "{{gateway_url}}/auth/register", "host": ["{{gateway_url}}"], "path": ["auth", "register"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var username = pm.globals.get('test_username');", "pm.request.body.raw = JSON.stringify({username: username, password: 'TestPass123!'});"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Registration returns 200 or 201', () => pm.expect(pm.response.code).to.be.oneOf([200, 201]));"], "type": "text/javascript"}}]
        },
        {
          "name": "2.3 User Login",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "X-Device-Id", "value": "postman-test-device"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"{{test_username}}\", \"password\": \"TestPass123!\"}"},
            "url": {"raw": "{{gateway_url}}/auth/login", "host": ["{{gateway_url}}"], "path": ["auth", "login"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var username = pm.globals.get('test_username');", "pm.request.body.raw = JSON.stringify({username: username, password: 'TestPass123!'});"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Login returns 200', () => pm.response.to.have.status(200));", "var jsonData = pm.response.json();", "pm.test('Returns tokens', () => {", "    pm.expect(jsonData.accessToken).to.be.a('string');", "    pm.expect(jsonData.refreshToken).to.be.a('string');", "});", "pm.globals.set('access_token', jsonData.accessToken);", "pm.globals.set('refresh_token', jsonData.refreshToken);", "var payload = JSON.parse(atob(jsonData.accessToken.split('.')[1]));", "pm.globals.set('user_id', payload.sub);", "console.log('User token saved, user_id: ' + payload.sub);"], "type": "text/javascript"}}]
        },
        {
          "name": "2.4 Login with Wrong Password (401)",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"{{test_username}}\", \"password\": \"WrongPassword\"}"},
            "url": {"raw": "{{gateway_url}}/auth/login", "host": ["{{gateway_url}}"], "path": ["auth", "login"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var username = pm.globals.get('test_username');", "pm.request.body.raw = JSON.stringify({username: username, password: 'WrongPassword'});"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Wrong password returns 401', () => pm.response.to.have.status(401));"], "type": "text/javascript"}}]
        }
      ]
    },
    {
      "name": "3. Authenticated User Endpoints",
      "item": [
        {
          "name": "3.1 Get Current User (/auth/me)",
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
            "url": {"raw": "{{gateway_url}}/auth/me", "host": ["{{gateway_url}}"], "path": ["auth", "me"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var token = pm.globals.get('access_token');", "if (token) { pm.request.headers.upsert({key: 'Authorization', value: 'Bearer ' + token}); }"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Get me returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns user info', () => pm.expect(pm.response.json().userId).to.exist);"], "type": "text/javascript"}}]
        },
        {
          "name": "3.2 Get Active Sessions",
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{access_token}}"}],
            "url": {"raw": "{{gateway_url}}/auth/sessions", "host": ["{{gateway_url}}"], "path": ["auth", "sessions"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var token = pm.globals.get('access_token');", "if (token) { pm.request.headers.upsert({key: 'Authorization', value: 'Bearer ' + token}); }"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Sessions returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns sessions array', () => pm.expect(pm.response.json()).to.be.an('array'));"], "type": "text/javascript"}}]
        },
        {
          "name": "3.3 Endpoint Without Token (401)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {"raw": "{{gateway_url}}/auth/me", "host": ["{{gateway_url}}"], "path": ["auth", "me"]}
          },
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Returns 401 without token', () => pm.response.to.have.status(401));"], "type": "text/javascript"}}]
        }
      ]
    },
    {
      "name": "4. Token Management",
      "item": [
        {
          "name": "4.1 Refresh Token",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"refreshToken\": \"{{refresh_token}}\"}"},
            "url": {"raw": "{{gateway_url}}/auth/refresh", "host": ["{{gateway_url}}"], "path": ["auth", "refresh"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var token = pm.globals.get('refresh_token');", "pm.request.body.raw = JSON.stringify({refreshToken: token});"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Refresh returns 200', () => pm.response.to.have.status(200));", "var jsonData = pm.response.json();", "pm.test('Returns new tokens', () => pm.expect(jsonData.accessToken).to.be.a('string'));", "pm.globals.set('access_token', jsonData.accessToken);", "if (jsonData.refreshToken) pm.globals.set('refresh_token', jsonData.refreshToken);"], "type": "text/javascript"}}]
        },
        {
          "name": "4.2 Logout",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "Authorization", "value": "Bearer {{access_token}}"}],
            "body": {"mode": "raw", "raw": "{\"refreshToken\": \"{{refresh_token}}\"}"},
            "url": {"raw": "{{gateway_url}}/auth/logout", "host": ["{{gateway_url}}"], "path": ["auth", "logout"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var token = pm.globals.get('access_token');", "var refreshToken = pm.globals.get('refresh_token');", "pm.request.headers.upsert({key: 'Authorization', value: 'Bearer ' + token});", "pm.request.body.raw = JSON.stringify({refreshToken: refreshToken});"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('Logout returns 200 or 204', () => pm.expect(pm.response.code).to.be.oneOf([200, 204]));"], "type": "text/javascript"}}]
        }
      ]
    },
    {
      "name": "5. JWKS (Public Key)",
      "item": [
        {
          "name": "5.1 Get JWKS",
          "request": {
            "method": "GET",
            "header": [],
            "url": {"raw": "{{gateway_url}}/auth/keys/jwks.json", "host": ["{{gateway_url}}"], "path": ["auth", "keys", "jwks.json"]}
          },
          "event": [{"listen": "test", "script": {"exec": ["pm.test('JWKS returns 200', () => pm.response.to.have.status(200));", "pm.test('Returns keys array', () => {", "    var keys = pm.response.json().keys;", "    pm.expect(keys).to.be.an('array');", "    pm.expect(keys.length).to.be.at.least(1);", "});"], "type": "text/javascript"}}]
        }
      ]
    },
    {
      "name": "6. Security Tests",
      "item": [
        {
          "name": "6.1 User Cannot Access Admin Port",
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "Authorization", "value": "Bearer {{access_token}}"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"hacker\", \"password\": \"hack123\"}"},
            "url": {"raw": "{{admin_url}}/admin/create", "host": ["{{admin_url}}"], "path": ["admin", "create"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var token = pm.globals.get('access_token');", "if (token) { pm.request.headers.upsert({key: 'Authorization', value: 'Bearer ' + token}); }"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["pm.test('User token rejected on admin port', () => pm.expect(pm.response.code).to.be.oneOf([401, 403]));"], "type": "text/javascript"}}]
        },
        {
          "name": "6.2 Gateway Does Not Expose Admin Routes",
          "request": {
            "method": "GET",
            "header": [],
            "url": {"raw": "{{gateway_url}}/admin/health", "host": ["{{gateway_url}}"], "path": ["admin", "health"]}
          },
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Gateway does not expose admin routes', () => pm.expect(pm.response.code).to.be.oneOf([404, 503]));"], "type": "text/javascript"}}]
        },
        {
          "name": "6.3 Old Key Rotation Endpoint Removed",
          "request": {
            "method": "POST",
            "header": [{"key": "Authorization", "value": "Bearer {{admin_token}}"}],
            "url": {"raw": "{{gateway_url}}/auth/keys/rotate", "host": ["{{gateway_url}}"], "path": ["auth", "keys", "rotate"]}
          },
          "event": [{"listen": "prerequest", "script": {"exec": ["var token = pm.globals.get('admin_token');", "if (token) { pm.request.headers.upsert({key: 'Authorization', value: 'Bearer ' + token}); }"], "type": "text/javascript"}}, {"listen": "test", "script": {"exec": ["// The old /auth/keys/rotate endpoint no longer exists in KeyRotationController", "// Gateway may return 401 (auth required) or 404/405 (not found)", "pm.test('Old rotate endpoint not functional', () => pm.expect(pm.response.code).to.be.oneOf([401, 404, 405, 503]));"], "type": "text/javascript"}}]
        }
      ]
    }
  ]
}
