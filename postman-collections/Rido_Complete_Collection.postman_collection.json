{
  "info": {
    "_postman_id": "rido-complete-v2",
    "name": "Rido Microservices - Complete Test Suite",
    "description": "Comprehensive API test collection. All auth requests go through Gateway at port 8080.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {"key": "base_url", "value": "http://localhost:8080"},
    {"key": "admin_url", "value": "http://localhost:9091"},
    {"key": "auth_token", "value": ""},
    {"key": "admin_token", "value": ""},
    {"key": "refresh_token", "value": ""},
    {"key": "user_id", "value": ""},
    {"key": "test_username", "value": ""},
    {"key": "test_password", "value": "TestPass123!"},
    {"key": "device_id", "value": "postman-device-001"},
    {"key": "session_id", "value": ""}
  ],
  "item": [
    {
      "name": "00 - Setup: Admin Login",
      "item": [
        {
          "name": "[P] Admin Health",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 200', () => pm.response.to.have.status(200));"]}}],
          "request": {"method": "GET", "header": [], "url": "{{admin_url}}/admin/health"}
        },
        {
          "name": "[P] Admin Login",
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status 200', () => pm.response.to.have.status(200));",
            "const json = pm.response.json();",
            "if(json.accessToken) pm.collectionVariables.set('admin_token', json.accessToken);"
          ]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"admin\", \"password\": \"adminpass\"}"},
            "url": "{{admin_url}}/admin/login"
          }
        }
      ]
    },
    {
      "name": "01 - Registration",
      "item": [
        {
          "name": "[P] Valid Registration",
          "event": [
            {"listen": "prerequest", "script": {"exec": ["pm.collectionVariables.set('test_username', 'user_' + Date.now());"]}},
            {"listen": "test", "script": {"exec": [
              "pm.test('Status 200', () => pm.response.to.have.status(200));",
              "pm.test('Status OK', () => pm.expect(pm.response.json().status).to.eql('ok'));"
            ]}}
          ],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"{{test_username}}\", \"password\": \"{{test_password}}\"}"},
            "url": "{{base_url}}/auth/register"
          }
        },
        {
          "name": "[N] Missing Username",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 400', () => pm.response.to.have.status(400));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"password\": \"TestPass123!\"}"},
            "url": "{{base_url}}/auth/register"
          }
        },
        {
          "name": "[N] Missing Password",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 400', () => pm.response.to.have.status(400));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"testuser\"}"},
            "url": "{{base_url}}/auth/register"
          }
        },
        {
          "name": "[N] Empty Username",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 400', () => pm.response.to.have.status(400));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"\", \"password\": \"TestPass123!\"}"},
            "url": "{{base_url}}/auth/register"
          }
        },
        {
          "name": "[N] Password Too Short",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 400', () => pm.response.to.have.status(400));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"testuser\", \"password\": \"12345\"}"},
            "url": "{{base_url}}/auth/register"
          }
        },
        {
          "name": "[N] Username Too Short",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 400', () => pm.response.to.have.status(400));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"ab\", \"password\": \"TestPass123!\"}"},
            "url": "{{base_url}}/auth/register"
          }
        },
        {
          "name": "[N] Duplicate Username",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 409', () => pm.response.to.have.status(409));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"{{test_username}}\", \"password\": \"TestPass123!\"}"},
            "url": "{{base_url}}/auth/register"
          }
        },
        {
          "name": "[N] Invalid JSON",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 400', () => pm.response.to.have.status(400));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{invalid json}"},
            "url": "{{base_url}}/auth/register"
          }
        }
      ]
    },
    {
      "name": "02 - Login",
      "item": [
        {
          "name": "[P] Valid Login",
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status 200', () => pm.response.to.have.status(200));",
            "const json = pm.response.json();",
            "pm.test('Has accessToken', () => pm.expect(json.accessToken).to.be.a('string'));",
            "pm.test('Has refreshToken', () => pm.expect(json.refreshToken).to.be.a('string'));",
            "pm.collectionVariables.set('auth_token', json.accessToken);",
            "pm.collectionVariables.set('refresh_token', json.refreshToken);"
          ]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "X-Device-Id", "value": "{{device_id}}"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"{{test_username}}\", \"password\": \"{{test_password}}\"}"},
            "url": "{{base_url}}/auth/login"
          }
        },
        {
          "name": "[N] Wrong Password",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"{{test_username}}\", \"password\": \"wrongpass\"}"},
            "url": "{{base_url}}/auth/login"
          }
        },
        {
          "name": "[N] Non-existent User",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"nonexistent_xyz\", \"password\": \"TestPass123!\"}"},
            "url": "{{base_url}}/auth/login"
          }
        },
        {
          "name": "[N] Missing Username",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 400', () => pm.response.to.have.status(400));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"password\": \"TestPass123!\"}"},
            "url": "{{base_url}}/auth/login"
          }
        },
        {
          "name": "[N] Empty Body",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 400', () => pm.response.to.have.status(400));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{}"},
            "url": "{{base_url}}/auth/login"
          }
        }
      ]
    },
    {
      "name": "03 - Protected Endpoints",
      "item": [
        {
          "name": "[P] Get Current User /me",
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status 200', () => pm.response.to.have.status(200));",
            "const json = pm.response.json();",
            "pm.test('Has id', () => pm.expect(json.id).to.be.a('string'));",
            "pm.collectionVariables.set('user_id', json.id);"
          ]}}],
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{auth_token}}"}],
            "url": "{{base_url}}/auth/me"
          }
        },
        {
          "name": "[N] /me Without Auth",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {"method": "GET", "header": [], "url": "{{base_url}}/auth/me"}
        },
        {
          "name": "[N] /me With Invalid Token",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer invalid.token.here"}],
            "url": "{{base_url}}/auth/me"
          }
        },
        {
          "name": "[P] Get Sessions",
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status 200', () => pm.response.to.have.status(200));",
            "pm.test('Is array', () => pm.expect(pm.response.json()).to.be.an('array'));",
            "const sessions = pm.response.json();",
            "if(sessions.length > 0) pm.collectionVariables.set('session_id', sessions[0].id);"
          ]}}],
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{auth_token}}"}],
            "url": "{{base_url}}/auth/sessions"
          }
        },
        {
          "name": "[N] Sessions Without Auth",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {"method": "GET", "header": [], "url": "{{base_url}}/auth/sessions"}
        },
        {
          "name": "[P] Secure Info",
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status 200', () => pm.response.to.have.status(200));",
            "pm.test('Has userId', () => pm.expect(pm.response.json().userId).to.be.a('string'));"
          ]}}],
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{auth_token}}"}],
            "url": "{{base_url}}/secure/info"
          }
        }
      ]
    },
    {
      "name": "04 - Refresh Token",
      "item": [
        {
          "name": "[P] Valid Refresh",
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status 200', () => pm.response.to.have.status(200));",
            "const json = pm.response.json();",
            "pm.collectionVariables.set('auth_token', json.accessToken);",
            "if(json.refreshToken) pm.collectionVariables.set('refresh_token', json.refreshToken);"
          ]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "X-Device-Id", "value": "{{device_id}}"}],
            "body": {"mode": "raw", "raw": "{\"refreshToken\": \"{{refresh_token}}\"}"},
            "url": "{{base_url}}/auth/refresh"
          }
        },
        {
          "name": "[N] Missing Refresh Token",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{}"},
            "url": "{{base_url}}/auth/refresh"
          }
        },
        {
          "name": "[N] Invalid Refresh Token",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"refreshToken\": \"invalid-token\"}"},
            "url": "{{base_url}}/auth/refresh"
          }
        }
      ]
    },
    {
      "name": "05 - JWKS",
      "item": [
        {
          "name": "[P] Get JWKS",
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status 200', () => pm.response.to.have.status(200));",
            "pm.test('Has keys array', () => pm.expect(pm.response.json().keys).to.be.an('array'));"
          ]}}],
          "request": {"method": "GET", "header": [], "url": "{{base_url}}/auth/keys/jwks.json"}
        },
        {
          "name": "[P] Get Well-Known JWKS",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 200', () => pm.response.to.have.status(200));"]}}],
          "request": {"method": "GET", "header": [], "url": "{{base_url}}/auth/keys/.well-known/jwks.json"}
        }
      ]
    },
    {
      "name": "06 - Logout",
      "item": [
        {
          "name": "[P] Valid Logout",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 200', () => pm.response.to.have.status(200));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "Authorization", "value": "Bearer {{auth_token}}"}],
            "body": {"mode": "raw", "raw": "{\"refreshToken\": \"{{refresh_token}}\"}"},
            "url": "{{base_url}}/auth/logout"
          }
        },
        {
          "name": "[N] Logout Missing Refresh Token",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{}"},
            "url": "{{base_url}}/auth/logout"
          }
        }
      ]
    },
    {
      "name": "07 - Admin Operations",
      "item": [
        {
          "name": "[N] Admin Login Wrong Password",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"admin\", \"password\": \"wrongpass\"}"},
            "url": "{{admin_url}}/admin/login"
          }
        },
        {
          "name": "[N] Admin Login Missing Fields",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 400', () => pm.response.to.have.status(400));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{}"},
            "url": "{{admin_url}}/admin/login"
          }
        },
        {
          "name": "[P] Get Audit Logs",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 200', () => pm.response.to.have.status(200));"]}}],
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{admin_token}}"}],
            "url": "{{admin_url}}/admin/audit/logs?page=0&size=10"
          }
        },
        {
          "name": "[N] Audit Logs Without Auth",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401 or 403', () => pm.expect([401,403]).to.include(pm.response.code));"]}}],
          "request": {"method": "GET", "header": [], "url": "{{admin_url}}/admin/audit/logs"}
        },
        {
          "name": "[P] Create Admin",
          "event": [
            {"listen": "prerequest", "script": {"exec": ["pm.collectionVariables.set('new_admin', 'admin_' + Date.now());"]}},
            {"listen": "test", "script": {"exec": ["pm.test('Status 200', () => pm.response.to.have.status(200));"]}}
          ],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}, {"key": "Authorization", "value": "Bearer {{admin_token}}"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"{{new_admin}}\", \"password\": \"NewAdmin123!\"}"},
            "url": "{{admin_url}}/admin/create"
          }
        },
        {
          "name": "[N] Create Admin Without Auth",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"newadmin\", \"password\": \"NewAdmin123!\"}"},
            "url": "{{admin_url}}/admin/create"
          }
        },
        {
          "name": "[P] Rotate Keys",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 200', () => pm.response.to.have.status(200));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Authorization", "value": "Bearer {{admin_token}}"}],
            "url": "{{admin_url}}/admin/key/rotate"
          }
        },
        {
          "name": "[N] Rotate Keys Without Auth",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {"method": "POST", "header": [], "url": "{{admin_url}}/admin/key/rotate"}
        }
      ]
    },
    {
      "name": "08 - Profile Service",
      "item": [
        {
          "name": "[P] Get My Profile",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 200 or 404', () => pm.expect([200,404]).to.include(pm.response.code));"]}}],
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{auth_token}}"}],
            "url": "{{base_url}}/profile/me"
          }
        },
        {
          "name": "[N] Get Profile Without Auth",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {"method": "GET", "header": [], "url": "{{base_url}}/profile/me"}
        },
        {
          "name": "[P] Get Addresses",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 200', () => pm.response.to.have.status(200));"]}}],
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{auth_token}}"}],
            "url": "{{base_url}}/profile/rider/addresses"
          }
        },
        {
          "name": "[P] Get Driver Documents",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 200', () => pm.response.to.have.status(200));"]}}],
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{auth_token}}"}],
            "url": "{{base_url}}/profile/driver/documents"
          }
        }
      ]
    },
    {
      "name": "09 - Security Tests",
      "item": [
        {
          "name": "[N] Tampered JWT",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 401', () => pm.response.to.have.status(401));"]}}],
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImZha2UifQ.eyJzdWIiOiIxMjM0NTY3ODkwIn0.invalid"}],
            "url": "{{base_url}}/profile/me"
          }
        },
        {
          "name": "[N] SQL Injection",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 400 or 401', () => pm.expect([400,401]).to.include(pm.response.code));"]}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"username\": \"admin'--\", \"password\": \"test\"}"},
            "url": "{{base_url}}/auth/login"
          }
        },
        {
          "name": "[N] Gateway Blocks Admin Routes",
          "event": [{"listen": "test", "script": {"exec": ["pm.test('Status 404', () => pm.response.to.have.status(404));"]}}],
          "request": {"method": "GET", "header": [], "url": "{{base_url}}/admin/health"}
        }
      ]
    }
  ]
}
